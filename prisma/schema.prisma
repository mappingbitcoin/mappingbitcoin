// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Venues table - exists only for FK integrity
// No venue data stored here â€” that's in memory
// ID is the OSM ID (e.g., "node/123456" or "way/789")
model Venue {
  id        String   @id // OSM ID as primary key
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  claims  Claim[]
  reviews Review[]

  @@map("venues")
}

// Users table - Nostr users with cached profile data
model User {
  id               String    @id @default(cuid())
  pubkey           String    @unique
  name             String?   // cached from kind 0
  displayName      String?   @map("display_name") // cached from kind 0
  picture          String?   // cached from kind 0
  nip05            String?
  profileUpdatedAt DateTime? @map("profile_updated_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Moderation
  bannedAt         DateTime? @map("banned_at")
  bannedReason     String?   @map("banned_reason")
  bannedBy         String?   @map("banned_by") // Admin pubkey who banned

  // Relations
  claims        Claim[]
  reviews       Review[]
  reviewReplies ReviewReply[]

  @@index([pubkey])
  @@index([bannedAt])
  @@map("users")
}

// Claims table - venue ownership claims
model Claim {
  id                   String      @id @default(cuid())
  venueId              String      @map("venue_id")
  claimerPubkey        String      @map("claimer_pubkey")
  status               ClaimStatus @default(PENDING)
  method               ClaimMethod
  verificationCode     String?     @map("verification_code")
  verificationAttempts Int         @default(0) @map("verification_attempts")
  verifiedAt           DateTime?   @map("verified_at")
  expiresAt            DateTime?   @map("expires_at")
  createdAt            DateTime    @default(now()) @map("created_at")
  verifiedEmailHash    String?     @map("verified_email_hash") // SHA-256 hash of verified email
  revokedAt            DateTime?   @map("revoked_at")
  revokedReason        String?     @map("revoked_reason") // e.g., "email_changed"

  // Domain verification fields
  domainToVerify       String?     @map("domain_to_verify") // e.g., "example.com"
  txtRecordValue       String?     @map("txt_record_value") // e.g., "mappingbitcoin-verify=abc123"
  lastCheckAt          DateTime?   @map("last_check_at") // Last manual check timestamp
  nextCheckAt          DateTime?   @map("next_check_at") // When next check is allowed (rate limiting)
  checkCount           Int         @default(0) @map("check_count") // Number of checks performed

  // Nostr event tracking
  nostrEventId         String?     @map("nostr_event_id") // Event ID of the verification announcement

  // Relations
  venue   Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)
  claimer User  @relation(fields: [claimerPubkey], references: [pubkey], onDelete: Cascade)

  @@index([venueId])
  @@index([claimerPubkey])
  @@index([status])
  @@map("claims")
}

// Auth challenges for Nostr authentication
model AuthChallenge {
  id        String    @id @default(cuid())
  pubkey    String
  challenge String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([pubkey])
  @@map("auth_challenges")
}

enum ClaimStatus {
  PENDING  @map("pending")
  VERIFIED @map("verified")
  REJECTED @map("rejected")
  EXPIRED  @map("expired")
}

enum ClaimMethod {
  PHONE    @map("phone")
  EMAIL    @map("email")
  DOMAIN   @map("domain")
  GOOGLE   @map("google")
  PHYSICAL @map("physical")
  MANUAL   @map("manual")
}

// Reviews table - venue reviews from Nostr
model Review {
  id             String   @id @default(cuid())
  eventId        String   @unique @map("event_id")
  venueId        String   @map("venue_id")
  authorPubkey   String   @map("author_pubkey")
  rating         Int?     // 1-5 stars, nullable for text-only reviews
  content        String?
  eventCreatedAt DateTime @map("event_created_at")
  indexedAt      DateTime @default(now()) @map("indexed_at")

  // Spam filtering
  spamScore      Float?       @map("spam_score")      // 0-1, higher = more likely spam
  spamStatus     SpamStatus   @default(PENDING) @map("spam_status")
  spamReasons    String[]     @map("spam_reasons")    // Array of reasons if flagged

  // Relations
  venue   Venue         @relation(fields: [venueId], references: [id], onDelete: Cascade)
  author  User          @relation(fields: [authorPubkey], references: [pubkey], onDelete: Cascade)
  replies ReviewReply[]

  @@index([venueId])
  @@index([authorPubkey])
  @@index([eventCreatedAt])
  @@index([spamStatus])
  @@map("reviews")
}

// Spam status for reviews
enum SpamStatus {
  PENDING   @map("pending")    // Awaiting moderation
  APPROVED  @map("approved")   // Manually or auto-approved
  FLAGGED   @map("flagged")    // Flagged for review
  BLOCKED   @map("blocked")    // Blocked as spam
}

// Review replies table
model ReviewReply {
  id             String   @id @default(cuid())
  eventId        String   @unique @map("event_id")
  reviewId       String   @map("review_id")
  authorPubkey   String   @map("author_pubkey")
  content        String
  isOwnerReply   Boolean  @default(false) @map("is_owner_reply")
  eventCreatedAt DateTime @map("event_created_at")
  indexedAt      DateTime @default(now()) @map("indexed_at")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorPubkey], references: [pubkey], onDelete: Cascade)

  @@index([reviewId])
  @@index([authorPubkey])
  @@map("review_replies")
}

// ============================================
// Newsletter Subscription System
// ============================================

// Subscription lists (e.g., newsletter, updates, announcements)
model SubscriptionList {
  id          String   @id @default(cuid())
  slug        String   @unique // e.g., "newsletter", "updates"
  name        String   // Display name
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  subscribers SubscriberList[]

  @@map("subscription_lists")
}

// Email subscribers
model Subscriber {
  id               String    @id @default(cuid())
  email            String    @unique
  unsubscribeToken String    @unique @map("unsubscribe_token")
  confirmedAt      DateTime? @map("confirmed_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  lists SubscriberList[]

  @@index([email])
  @@index([unsubscribeToken])
  @@map("subscribers")
}

// Many-to-many relation: subscribers to lists
model SubscriberList {
  id             String    @id @default(cuid())
  subscriberId   String    @map("subscriber_id")
  listId         String    @map("list_id")
  subscribedAt   DateTime  @default(now()) @map("subscribed_at")
  unsubscribedAt DateTime? @map("unsubscribed_at")

  // Relations
  subscriber Subscriber       @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  list       SubscriptionList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, listId])
  @@index([subscriberId])
  @@index([listId])
  @@map("subscriber_lists")
}

// ============================================
// Community Trust System
// ============================================

// Admin users who can manage seeders and system settings
model AdminUser {
  id        String   @id @default(cuid())
  pubkey    String   @unique
  label     String?
  createdAt DateTime @default(now()) @map("created_at")

  @@map("admin_users")
}

// Community seeders - trusted nodes in the social graph
model CommunitySeeder {
  id        String   @id @default(cuid())
  pubkey    String   @unique
  region    String
  label     String?
  addedBy   String?  @map("added_by")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("community_seeders")
}

// Pre-computed trust graph nodes with follower counts by depth
model CommunityGraph {
  id               String   @id @default(cuid())
  pubkey           String   @unique

  // Is this pubkey a seeder themselves?
  isSeeder         Boolean  @default(false) @map("is_seeder")

  // Follower counts: how many people at each depth follow this user
  followedByDepth0 Int      @default(0) @map("followed_by_depth_0")  // Seeders who follow this user
  followedByDepth1 Int      @default(0) @map("followed_by_depth_1")  // Depth-1 users who follow this user
  followedByDepth2 Int      @default(0) @map("followed_by_depth_2")  // Depth-2 users who follow this user

  // Total followers in the trust network
  totalTrustFollowers Int   @default(0) @map("total_trust_followers")

  // Minimum depth at which this user appears (0=seeder, 1=followed by seeder, etc)
  minDepth         Int      @map("min_depth")

  // Calculated trust score (can be recomputed from counts)
  score            Float

  computedAt       DateTime @default(now()) @map("computed_at")

  @@index([score(sort: Desc)])
  @@index([minDepth])
  @@index([followedByDepth0(sort: Desc)])
  @@map("community_graph")
}

// Cache for Nostr follows (kind 3 events)
model FollowsCache {
  id            String   @id @default(cuid())
  pubkey        String
  followsPubkey String   @map("follows_pubkey")
  fetchedAt     DateTime @default(now()) @map("fetched_at")

  @@unique([pubkey, followsPubkey])
  @@index([pubkey])
  @@map("follows_cache")
}

// Log of graph build operations
model GraphBuildLog {
  id           String           @id @default(cuid())
  startedAt    DateTime         @default(now()) @map("started_at")
  completedAt  DateTime?        @map("completed_at")
  status       GraphBuildStatus
  seedersCount Int?             @map("seeders_count")
  nodesCount   Int?             @map("nodes_count")
  errorMessage String?          @map("error_message")

  @@map("graph_build_logs")
}

enum GraphBuildStatus {
  RUNNING   @map("running")
  COMPLETED @map("completed")
  FAILED    @map("failed")
}

// ============================================
// Marketing Content Seeder System
// ============================================

enum SocialNetwork {
  TWITTER   @map("twitter")
  INSTAGRAM @map("instagram")
  LINKEDIN  @map("linkedin")
  FACEBOOK  @map("facebook")
  TIKTOK    @map("tiktok")
  YOUTUBE   @map("youtube")
  NOSTR     @map("nostr")
}

enum PostType {
  IMAGE       @map("image")
  VIDEO       @map("video")
  CAROUSEL    @map("carousel")
  STORY       @map("story")
  REEL        @map("reel")
  TEXT        @map("text")
  INFOGRAPHIC @map("infographic")
}

enum ContentTopic {
  ANNOUNCEMENTS @map("announcements")
  EDUCATION     @map("education")
  COMMUNITY     @map("community")
  PRODUCT       @map("product")
  NEWS          @map("news")
  EVENTS        @map("events")
  TIPS          @map("tips")
  OTHER         @map("other")
}

// Brand voice, guidelines, do/don't lists - single row config
model MarketingGuidelines {
  id           String   @id @default(cuid())
  voiceTone    String?  @map("voice_tone")     // Brand voice description
  doList       String[] @map("do_list")        // Things to do in content
  dontList     String[] @map("dont_list")      // Things to avoid
  brandValues  String[] @map("brand_values")   // Core brand values
  updatedAt    DateTime @updatedAt @map("updated_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("marketing_guidelines")
}

// Link library for marketing content
model MarketingLink {
  id          String   @id @default(cuid())
  title       String
  url         String
  description String?
  category    String   // e.g., "website", "social", "resources", "campaigns"
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("marketing_links")
}

// Media assets stored in Hetzner with tagging
model MarketingAsset {
  id             String          @id @default(cuid())
  filename       String          // Original filename
  storageKey     String          @unique @map("storage_key") // Key in Hetzner storage
  mimeType       String          @map("mime_type")
  size           Int             // File size in bytes
  socialNetworks SocialNetwork[] @map("social_networks")
  postTypes      PostType[]      @map("post_types")
  topic          ContentTopic?
  customTags     String[]        @map("custom_tags")
  altText        String?         @map("alt_text")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@index([topic])
  @@map("marketing_assets")
}

// Named groups of hashtags
model HashtagSet {
  id             String          @id @default(cuid())
  name           String          @unique
  hashtags       String[]        // Array of hashtags (without #)
  socialNetworks SocialNetwork[] @map("social_networks")
  description    String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@map("hashtag_sets")
}

// Example posts for each social network
model ExamplePost {
  id            String        @id @default(cuid())
  socialNetwork SocialNetwork @map("social_network")
  content       String        // The post content
  hashtags      String[]      // Hashtags used
  notes         String?       // Internal notes about why this works
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@index([socialNetwork])
  @@map("example_posts")
}

// Marketing statistics and facts
model MarketingStat {
  id          String    @id @default(cuid())
  label       String    // e.g., "Active Users", "Countries Served"
  value       String    // The stat value (as string for flexibility)
  source      String?   // Where this stat comes from
  category    String    // e.g., "growth", "engagement", "reach"
  expiresAt   DateTime? @map("expires_at") // When this stat should be reviewed
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([category])
  @@map("marketing_stats")
}

// n8n Generation Configuration (single row)
model GenerationConfig {
  id                  String   @id @default(cuid())

  // Generation Config
  postsPerPlatform    Json     @default("{}") @map("posts_per_platform")     // e.g., { "x": 20, "nostr": 15, "instagram": 10 }
  contentMixWeights   Json     @default("{}") @map("content_mix_weights")    // e.g., { "venue_spotlight": 40, "education": 30 }
  generateImages      Boolean  @default(false) @map("generate_images")
  aiModel             String   @default("sonnet") @map("ai_model")           // "sonnet" or "opus"

  // Scheduling Config
  postsPerDay         Json     @default("{}") @map("posts_per_day")          // e.g., { "x": 2, "nostr": 1, "instagram": 1 }
  activeHoursStart    String   @default("12:00") @map("active_hours_start")
  activeHoursEnd      String   @default("22:00") @map("active_hours_end")
  timezone            String   @default("UTC")
  activeDays          String[] @default(["mon", "tue", "wed", "thu", "fri", "sat", "sun"]) @map("active_days")

  // Webhook
  webhookUrl          String?  @map("webhook_url")
  webhookSecret       String?  @map("webhook_secret")
  lastTriggeredAt     DateTime? @map("last_triggered_at")

  updatedAt           DateTime @updatedAt @map("updated_at")
  createdAt           DateTime @default(now()) @map("created_at")

  @@map("generation_config")
}
